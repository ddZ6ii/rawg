#!/usr/bin/env sh

while IFS=' ' read -r local_ref local_sha remote_ref remote_sha; do
  # Skip branch deletions
  [ "$local_sha" = "0000000000000000000000000000000000000000" ] && continue

  # Skip non-branch refs (tags, notes, etc.)
  case "$local_ref" in refs/heads/*) ;; *) continue ;; esac

  if [ "$remote_sha" = "0000000000000000000000000000000000000000" ]; then
    # New branch: validate only commits since diverging from main or dev
    from=$(git merge-base HEAD origin/main 2>/dev/null || git merge-base HEAD origin/dev 2>/dev/null)
    [ -z "$from" ] && continue
  else
    from="$remote_sha"
  fi

  pnpm exec commitlint --from "$from" --to "$local_sha" || exit 1
done