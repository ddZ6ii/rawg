# Reusable workflow for running code quality checks
name: shared-quality

on:
  workflow_call: # ðŸ‘ˆ makes the workflow reusable and allows it to be called from other workflows

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Format code
        run: pnpm run format:check

      - name: Lint code
        run: pnpm run lint

  check-licences:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Check licences
        run: pnpm dlx license-checker-rseidelsohn --onlyAllow "MIT;ISC;Apache-2.0;BSD-2-Clause;BSD-3-Clause;0BSD;Unlicense;CC0-1.0;CC-BY-3.0;CC-BY-4.0" --excludePrivatePackages

  audit-deps:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Audit dependencies
        run: pnpm dlx audit-ci --config .audit-ci.json

  audit-actions:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Audit GitHub Actions security
        uses: zizmorcore/zizmor-action@v0.5.0
        with:
          config: zizmor.yml
          advanced-security: false # output to CI logs only â€” security-events: write not granted

  test:
    needs: [code-quality, check-licences, audit-deps, audit-actions]
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        with:
          persist-credentials: false

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Run tests
        run: pnpm run test
