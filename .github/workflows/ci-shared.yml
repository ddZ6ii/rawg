name: ci-shared

on:
  workflow_call: # ðŸ‘ˆ makes the workflow reusable and allows it to be called from other workflows (e.g., ci-dev.yml and ci-main.yml)
    inputs:
      image-tag:
        description: 'Docker image tag'
        required: true
        type: string
      push-latest:
        description: 'Whether to also tag the image as latest'
        required: false
        type: string
        default: 'false'
    # ðŸ‘‡ Secrets are scoped to the workflow that owns them and are not automatically inherited by reusable workflows to have full visibility and control over what sensitive data is being passed around (GitHub Actions security design decision). Thus it must be explicitly passed from the caller workflow.
    secrets:
      DOCKERHUB_TOKEN:
        description: 'Docker personal access token'
        required: true

jobs:
  code-quality:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Format code
        run: pnpm run format:check

      - name: Lint code
        run: pnpm run lint

  test:
    needs: code-quality
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Setup environment
        uses: ./.github/actions/setup-environment

      - name: Run tests
        run: pnpm run test

  build-and-publish:
    needs: test
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4

      - name: Build and push Docker image
        uses: ./.github/actions/build-push-docker
        with:
          docker-username: ${{ vars.DOCKERHUB_USERNAME }}
          docker-repository: ${{ vars.DOCKERHUB_REPO }}
          docker-token: ${{ secrets.DOCKERHUB_TOKEN }}
          image-tag: ${{ inputs.image-tag }}
          push-latest: ${{ inputs.push-latest }}
